<?php include "globals.php"; ?>
<style type="text/css">.title {	border-bottom: groove 1px;	border-top: groove 1px;	padding: 3px 0 3px 0;	text-align: center;}.content {	margin: 2% 3% 0 3%;}</style>
<?php
function BBCode($str) {	$search = array(					'#\[b\](.*?)\[/b\]#is',					'#\[u\](.*?)\[/u\]#is',					'#\[i\](.*?)\[/i\]#is',					'#\[color=\#?([A-F0-9]{3}|[A-F0-9]{6})\](.*?)\[/color\]#is',					'#\[url\]((?:ftp|https?)://.*?)\[/url\]#i',					'#\[img\](https?://.*?\.(?:jpg|jpeg|gif|png|bmp))\[/img\]#i'					);	$replace = array(					 '<strong>$1</strong>',					 '<span style="text-decoration: underline;">$1</span>',					 '<em>$1</em>',					 '<span style="color: #$1;">$2</span>',					 '<a href="$1">$1</a>',					 '<img src="$1" alt="" />'					 );	$str = preg_replace($search, $replace, $str);	$str = nl2br($str);	return $str;}switch($_GET['Page']) {	
case 'Sales': sales_support(); break;	
case 'General': general_support(); break;	
case 'Bug': bug_support(); break;	
case 'Ticket': view_ticket(); break;	
default: support_home(); break;}

function support_home() {	
global $db, $h, $ir;	
echo '<div class="content">		<div class="title"><span style="font-size: 18px;">Support Desk</span></div><br />		
If you need help with any features of the game, found a Bug or have a Problem with a Donation; you are able to Submit a Support Ticket and a Member of Staff will assist you with that problem as soon as possible.<br /><br />		<table width="65%" class="table" border="1" cellspacing="2" align="center"><tr>			<td width="33%">&gt; <a href="?Page=Sales">Sales Support</a></td>			<td width="34%">&gt; <a href="?Page=General">General Support</a></td>			<td width="33%">&gt; <a href="?Page=Bug">Bug Support</a></td>		</tr></table><br />		<table width="95%" class="table" align="center" cellpadding="2" border="1"><tr>			<td width="15%"><strong>Department</strong></td>			<td width="45%"><strong>Topic</strong></td>			<td width="30%"><strong>Last Reply</strong></td>			<td width="10%"><strong>Status</strong></td>		</tr>';		
$query = $db->query('SELECT * FROM `support` WHERE `sUser`='.abs(intval($ir['userid'])).'');		
if(!$db->num_rows($query)) {			
echo '<tr><td colspan="4" align="center"><strong>You currently have no outstanding Support Tickets</strong></td></tr>';		} 
else
 {			while($q = $db->fetch_row($query)) {				
 if($q['sLastReply'] >= 1) {					
 $user = $db->query('SELECT `userid`,`username` FROM `users` WHERE (`userid`='.abs(intval($q['sLastReply'])).')');					
 $u = $db->fetch_row($user);					
 $l = '<a href="viewuser.php?u='.abs(intval($u['userid'])).'">'.stripslashes($u['username']).'</a>';				} 
 else 
 {					
 $l = 'Awaiting Reply.';				}				
 echo '<tr>					<td>'.$q['sSupportType'].'</td>					<td><a href="?Page=Ticket&ID='.abs(intval($q['sID'])).'">'.stripslashes($q['sTitle']).'</a></td>					<td>'.$l.'</td>					<td>'.$q['sStatus'].'</td>				</tr>';			}		}		
 echo '</table>	</div>';}
 
 function sales_support() {	
 global $db, $h, $ir;	
 echo '<div class="content">		<div class="title"><span style="font-size: 18px;">Support Desk - Sales Support</span></div><br />';		
 if(isset($_POST['salesButton'])) {			
 if(empty($_POST['salesTitle']) || empty($_POST['salesEmail']) || empty($_POST['salesTrans']) || empty($_POST['salesPackage'])) {				
 echo '<div align="center"><strong>You need to fill out ALL of the <span style="color: red;">*</span> fields!</strong></div><br />';			} 
 elseif(!filter_var($_POST['salesEmail'], FILTER_VALIDATE_EMAIL)) {				
 echo '<div align="center"><strong>Please enter a Valid Email!</strong></div><br />';			} 
 else 
 {				
 $ID = abs(intval($ir['userid']));				
 $title = mysql_real_escape_string(htmlentities($_POST['salesTitle']));				
 $email = filter_var($_POST['salesEmail'], FILTER_VALIDATE_EMAIL);				
 $trans = mysql_real_escape_string(htmlentities($_POST['salesTrans']));				
 $pack = mysql_real_escape_string(htmlentities($_POST['salesPackage']));				
 $info = mysql_real_escape_string(htmlentities($_POST['salesInfo']));				
 $db->query('INSERT INTO `support` VALUES("", '.$ID.', "'.$title.'", "'.$info.'", "Open", "Sales", 0, '.time().', "'.$email.'", "'.$_POST['salesMethod'].'", "'.$trans.'", "'.$pack.'")');				
 echo '<div align="center"><strong>Support Ticket Submitted!</strong></div><br />';			}		}		
 echo 'If you bought more than 1 item; then please submit the same number of Tickets as items bought (1 for each item) e.g. You bought 1 Crystals Package and 1 Donator Package - Submit 1 Ticket for the Crystals and 1 for the Donator Package!<br /><br />		
 If the Sales Support is used for anything other than Sales Support, there could be repercussions!<br /><br />		
 <form action="#" method="post">		<table width="70%" align="center" cellpadding="2" cellspacing="2"><tr>			<td width="30%"><strong>Department:</strong></td>			<td width="70%">Sales</td>		</tr><tr>			<td><span style="color: red;">*</span> <strong>Topic:</strong><br /><small>Max 40 chars.</small></td>			<td><input type="text" STYLE="color: black;  background-color: white;" name="salesTitle" maxlength="40" size="45"/></td>		</tr><tr>			<td><strong>Method:</strong><br /><small>In which you paid</small></td>			<td><select type="dropdown" name="salesMethod">					<option value="Paypal">Paypal</option>										</select></td>		</tr><tr>			<td><span style="color: red;">*</span> <strong>Email:</strong><br /><small>Used to pay</small></td>			<td><input type="text" STYLE="color: black;  background-color: white;" name="salesEmail" size="45"/></td>		</tr><tr>			<td><span style="color: red;">*</span> <strong>Transaction ID:</stron></td>			<td><input type="text" STYLE="color: black;  background-color: white;" name="salesTrans" size="45"/></td>		</tr><tr>			<td><span style="color: red;">*</span> <strong>Package Bought:</strong></td>			<td><input type="text" STYLE="color: black;  background-color: white;" name="salesPackage" size="45"/></td>		</tr><tr>			<td><strong>Other Info:</strong><br /><small>BBCode may be used.</small></td>			<td><textarea name="salesInfo" rows="6" cols="56" STYLE="color: black;  background-color: white;"></textarea></td>		</tr><tr>			<td></td>			<td><input type="submit" STYLE="color: black;  background-color: white;" name="salesButton" value="Submit Ticket!" class="btn"></td>		</tr></table>		</form><br />		<div class="title">&gt; <a href="?">Back</a></div>	</div>';}function general_support() {	global $db, $h, $ir;	echo '<div class="content">		<div class="title"><span style="font-size: 18px;">Support Desk - General Support</span></div><br />';		if(isset($_POST['generalButton'])) {			if(empty($_POST['generalTitle']) || empty($_POST['generalQuery'])) {				echo '<div align="center"><strong>You need to fill out ALL of the <span style="color: red;">*</span> fields!</strong></div><br />';			} else {				$ID = abs(intval($ir['userid']));				$title = mysql_real_escape_string(htmlentities($_POST['generalTitle']));				$query = mysql_real_escape_string(htmlentities($_POST['generalQuery']));				$db->query('INSERT INTO `support` (`sUser`,`sTitle`,`sMessage`,`sStatus`,`sSupportType`,`sLastReply`,`sLastReplyTime`) VALUES('.$ID.', "'.$title.'", "'.$query.'", "Open", "General", 0, '.time().')');				echo '<div align="center"><strong>Support Ticket Submitted!</strong></div><br />';			}		}		echo 'This section of the Support Desk is for anything Game Related.<br /><br />		<form action="#" method="post">		<table width="70%" align="center" cellpadding="2" cellspacing="2"><tr>			<td width="30%"><strong>Department:</strong></td>			<td width="70%">General</td>		</tr><tr>			<td><span style="color: red;">*</span> <strong>Topic:</strong><br /><small>Max 40 chars.</small></td>			<td><input type="text" STYLE="color: black;  background-color: white;" name="generalTitle" maxlength="40" size="45"/></td>		</tr><tr>			<td><span style="color: red;">*</span> <strong>Query/Question:</strong><br /><small>BBCode may be used.</small></td>			<td><textarea name="generalQuery" rows="6" cols="56"></textarea></td>		</tr><tr>			<td></td>			<td><input type="submit" STYLE="color: black;  background-color: white;" name="generalButton" value="Submit Ticket!" class="btn"></td>		</tr></table>		</form><br />		<div class="title">&gt; <a href="?">Back</a></div>	</div>';}function bug_support() {	global $db, $h, $ir;	echo '<div class="content">		<div class="title"><span style="font-size: 18px;">Support Desk - Bug Support</span></div><br />';		if(isset($_POST['bugButton'])) {			if(empty($_POST['bugTitle']) || empty($_POST['bugInfo'])) {				echo '<div align="center"><strong>You need to fill out ALL of the <span style="color: red;">*</span> fields!</strong></div><br />';			} else {				$ID = abs(intval($ir['userid']));				$title = mysql_real_escape_string(htmlentities($_POST['bugTitle']));				$bug = mysql_real_escape_string(htmlentities($_POST['bugInfo']));				$db->query('INSERT INTO `support` (`sUser`,`sTitle`,`sMessage`,`sStatus`,`sSupportType`,`sLastReply`,`sLastReplyTime`) VALUES('.$ID.', "'.$title.'", "'.$bug.'", "Open", "Bug", 0, '.time().')');				echo '<div align="center"><strong>Support Ticket Submitted!</strong></div><br />';			}		}		echo 'This section of the Support Desk is for anything that you think may be a Bug. Please include the URL of the suspected Bug in the Information section.<br /><br />		Failure to provide a link, or what the Bug does will result in this Ticket being closed and ignored.<br /><br />		<form action="#" method="post">		<table width="70%" align="center" cellpadding="2" cellspacing="2"><tr>			<td width="30%"><strong>Department:</strong></td>			<td width="70%">Bug</td>		</tr><tr>			<td><span style="color: red;">*</span> <strong>Topic:</strong><br /><small>Max 40 chars.</small></td>			<td><input type="text" STYLE="color: black;  background-color: white;" name="bugTitle" maxlength="40" size="45"/></td>		</tr><tr>			<td><span style="color: red;">*</span> <strong>Information:</strong><br /><small>BBCode may be used.</small></td>			<td><textarea name="bugInfo" rows="6" cols="56"></textarea></td>		</tr><tr>			<td></td>			<td><input type="submit" STYLE="color: black;  background-color: white;" name="bugButton" value="Submit Ticket!" class="btn"></td>		</tr></table>		</form><br />		<div class="title">&gt; <a href="?">Back</a></div>	</div>';}function view_ticket() {	global $db, $h, $ir;	$_GET['ID'] = abs(intval($_GET['ID']));	echo '<div class="content">';		if(!$_GET['ID']) {			echo '<div class="title"><span style="font-size: 18px;">View Ticket - Error</span></div><br />			<div align="center"><strong>Check your Source.</strong></div><br />			<div class="title">&gt; <a href="?">Back</a></div>';		} else {			$query = $db->query('SELECT * FROM `support` WHERE (`sID`='.$_GET['ID'].' AND `sUser`='.abs(intval($ir['userid'])).')');			if(!$db->num_rows($query)) {				echo '<div class="title"><span style="font-size: 18px;">View Ticket - Error</span></div><br />				<div align="center"><strong>We couldn\'t locate a Ticket with that ID, submitted by yourself.</strong></div><br />				<div class="title">&gt; <a href="?">Back</a></div>';			} else {				$q = $db->fetch_row($query);				echo '<div class="title"><span style="font-size: 18px;">View Ticket</span></div><br />				<table width="95%" cellpadding="2" cellspacing="2" align="center"><tr>					<td width="20%"><strong>Department:</strong></td>					<td width="80%">'.$q['sSupportType'].'</td>				</tr><tr>					<td><strong>Topic:</strong></td>					<td>'.stripslashes($q['sTitle']).'</td>				</tr>';				if($q['sSupportType'] == 'Sales') {					echo '<tr>						<td><strong>Payment Method:</strong></td>						<td>'.$q['sSalesMethod'].'</td>					</tr><tr>						<td><strong>Payment Email:</strong></td>						<td>'.$q['sSalesEmail'].'</td>					</tr><tr>						<td><strong>Transaction ID:</strong></td>						<td>'.stripslashes($q['sSalesTransaction']).'</td>					</tr><tr>						<td><strong>Package Brought:</strong></td>						<td>'.stripslashes($q['sSalesPackage']).'</td>					</tr>';				}				echo '<tr>					<td valign="top"><strong>Body:</strong></td>					<td>'.BBCode(stripslashes($q['sMessage'])).'</td>				</tr></table><br />				<div class="title"><span style="font-size: 15px;">Replies</span></div><br />';				if(isset($_POST['topicButton'])) {					if(empty($_POST['topicReply'])) {						echo '<div align="center"><strong>You cannot leave the Reply blank!</strong></div><br />';					} else {						$ID = abs(intval($ir['userid']));						$reply = mysql_real_escape_string(htmlentities($_POST['topicReply']));						$db->query('UPDATE `support` SET `sLastReply`='.$ID.', `sLastReplyTime`='.time().' WHERE (`sID`='.$_GET['ID'].')');						$db->query('INSERT INTO `supportreplies` VALUES("", "'.$_GET['ID'].'", '.$ID.', "'.$reply.'", '.time().')');						echo '<div align="center"><strong>You have left a Reply..</strong></div><br />';					}				}				$replies = $db->query('SELECT * FROM `supportreplies` WHERE (`rTopic`='.$_GET['ID'].')');				if(!$db->num_rows($replies)) {					echo '';				} else {					echo '<table width="95%" cellpadding="2" cellspacing="2" align="center">';					while($r = $db->fetch_row($replies)) {						$user = $db->query('SELECT `userid`,`username` FROM `users` WHERE (`userid`='.abs(intval($r['rUser'])).')');						$u = $db->fetch_row($user);						echo '<tr>							<td width="20%" valign="top"><a href="viewuser.php?u='.abs(intval($u['userid'])).'">'.stripslashes($u['username']).'</a><br />							<small>'.date('F j, Y', $r['rTime']).'</small></td>							<td width="80%">'.BBCode(stripslashes($r['rMessage'])).'</td>						</tr>';					}					echo '</table>';				}				if($q['sStatus'] == 'Open') {					echo '<form action="#" method="post">					<table width="95%" cellpadding="2"  cellspacing="2" align="center"><tr>						<td><strong>Reply:</strong><br /><small>BBCode may be used.</small></td>						<td><textarea name="topicReply" rows="6" cols="97"></textarea><br />								<input type="submit" STYLE="color: black;  background-color: white;" name="topicButton" value="Add Reply!" class="btn"></td>					</tr></table>					</form>';				}			}		}}$h->endpage();?>